#!/usr/bin/env node
"use strict";

const fs = require("fs");
const path = require("path");

const inputPath = process.argv[2] || path.join("assets", "core", "index.js");
const outputPath = process.argv[3] || path.join("docs", "maps", "core-index.md");

if (!fs.existsSync(inputPath)) {
  console.error(`Input not found: ${inputPath}`);
  process.exit(1);
}

const text = fs.readFileSync(inputPath, "utf8");
const lines = text.split(/\r?\n/);
const stats = fs.statSync(inputPath);

const keywords = [
  "mint",
  "inscription",
  "chunk",
  "batch",
  "seal",
  "wallet",
  "auth",
  "connect",
  "fee",
  "contract",
  "gallery",
  "viewer",
  "player",
  "manifest",
  "preview",
  "audio",
  "video",
  "image",
  "merkle",
  "root",
  "cache",
  "resume",
  "retry",
  "upload",
  "download",
  "provider",
  "stacks",
  "hiro",
  "signature",
  "session",
  "safe",
  "overlay",
  "media",
  "file",
  "mime",
  "royalty",
  "nonce",
  "storage",
  "debug"
];

const keywordRe = new RegExp(keywords.join("|"), "i");
const allowlist = new Set([
  "journeyLog",
  "safeSerialize",
  "installGlobalErrorLogging",
  "openContractCallWrapper",
  "callReadOnlyFunctionWithRetry"
]);

const anchors = new Map();
const domIds = new Map();
const storageKeys = new Map();
const contractFns = new Map();

function addItem(map, key, name, line) {
  if (map.has(key)) {
    const existing = map.get(key);
    existing.count += 1;
    return;
  }
  map.set(key, { name, line, count: 1 });
}

function collectMatches(regex, line, onMatch) {
  regex.lastIndex = 0;
  let match;
  while ((match = regex.exec(line)) !== null) {
    onMatch(match);
    if (match.index === regex.lastIndex) {
      regex.lastIndex += 1;
    }
  }
}

function shouldKeepAnchor(name) {
  if (!name || name.length < 4) return false;
  if (allowlist.has(name)) return true;
  return keywordRe.test(name);
}

let appStartLine = 1;
for (let i = 0; i < lines.length; i += 1) {
  const line = lines[i];
  if (line.includes("journeyLog(\"App loading")) {
    appStartLine = i + 1;
    break;
  }
}
if (appStartLine === 1) {
  for (let i = 0; i < lines.length; i += 1) {
    const line = lines[i];
    if (line.includes("journeyLog=") || line.includes("journeyLog =")) {
      appStartLine = i + 1;
      break;
    }
  }
}
const anchorStartLine = Math.max(1, appStartLine - 20);

for (let i = 0; i < lines.length; i += 1) {
  const line = lines[i];
  const lineNo = i + 1;

  if (lineNo >= anchorStartLine) {
    collectMatches(/\bfunction\s+([A-Za-z_$][\w$]*)\s*\(/g, line, (m) => {
      const name = m[1];
      if (shouldKeepAnchor(name)) {
        addItem(anchors, `function:${name}`, `${name} (function)`, lineNo);
      }
    });

    collectMatches(/\bclass\s+([A-Za-z_$][\w$]*)\b/g, line, (m) => {
      const name = m[1];
      if (shouldKeepAnchor(name)) {
        addItem(anchors, `class:${name}`, `${name} (class)`, lineNo);
      }
    });

    collectMatches(/\b(?:const|let|var)\s+([A-Za-z_$][\w$]*)\s*=/g, line, (m) => {
      const name = m[1];
      if (shouldKeepAnchor(name)) {
        addItem(anchors, `var:${name}`, `${name} (const/let)`, lineNo);
      }
    });
  }

  collectMatches(/\bgetElementById\(\s*["']([^"']+)["']\s*\)/g, line, (m) => {
    addItem(domIds, m[1], m[1], lineNo);
  });

  collectMatches(/\bquerySelector(All)?\(\s*["']#([^"']+)["']\s*\)/g, line, (m) => {
    addItem(domIds, m[2], m[2], lineNo);
  });

  collectMatches(/\blocalStorage\.(?:getItem|setItem|removeItem)\(\s*["']([^"']+)["']/g, line, (m) => {
    addItem(storageKeys, m[1], m[1], lineNo);
  });

  collectMatches(/\bfunctionName\s*:\s*["']([^"']+)["']/g, line, (m) => {
    addItem(contractFns, m[1], m[1], lineNo);
  });
}

function toSortedList(map) {
  return Array.from(map.values()).sort((a, b) => {
    if (a.line !== b.line) return a.line - b.line;
    return a.name.localeCompare(b.name);
  });
}

function formatList(items) {
  if (items.length === 0) return "- (none)\n";
  return items
    .map((item) => {
      const count = item.count > 1 ? ` (x${item.count})` : "";
      return `- line ${item.line}: ${item.name}${count}`;
    })
    .join("\n");
}

const output = [
  "# Core Index (generated)",
  "",
  `Source: ${inputPath}`,
  `Bytes: ${stats.size}`,
  `Lines: ${lines.length}`,
  "",
  "## App anchors (functions/classes/consts)",
  formatList(toSortedList(anchors)),
  "",
  "## DOM IDs referenced in core",
  formatList(toSortedList(domIds)),
  "",
  "## localStorage keys referenced in core",
  formatList(toSortedList(storageKeys)),
  "",
  "## Contract functionName calls",
  formatList(toSortedList(contractFns)),
  "",
  "Generated by tools/generate-core-index.js"
].join("\n");

fs.mkdirSync(path.dirname(outputPath), { recursive: true });
fs.writeFileSync(outputPath, output, "utf8");

console.log(`Wrote ${outputPath}`);

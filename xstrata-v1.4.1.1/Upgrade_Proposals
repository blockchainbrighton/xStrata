

# ğŸš€ Breakdown of Potential Upgrades

---

## 1ï¸âƒ£ Local Storage State Persistence

### *The â€œAuto-Resumeâ€ Feature*

**User Question**

> Can we use local storage to keep tabs on chunk statesâ€¦ so we can offer an auto-resume process?

### âœ… Verdict

**YES â€” this is the highest value / lowest effort upgrade.**

---

### ğŸ”§ How It Would Work

#### 1. Save State

Whenever `startChunkUploads` successfully confirms (or sends) a chunk, persist state to `localStorage`:

```js
{
  "pending_mint_0x123...": {
    "fileName": "art.png",
    "totalChunks": 50,
    "uploadedIndices": [0, 1, 2, ...],
    "lastUpdated": 1700000000
  }
}
```

#### 2. Detection

On page load (`initAuthAndUI`):

* Scan `localStorage` for keys starting with `pending_mint_`

#### 3. UI

Display an **Unfinished Jobs** widget:

> *â€œYou have an unfinished upload for **art.png** â€” 15 / 50 chunks sent.â€*
> `[ Resume ]`

#### 4. Reconciliation (Important âš ï¸)

When **Resume** is clicked, **do not blindly trust local storage**:

* Call `get-pending-inscription` on-chain
* Call `get-chunk` for indices we believe are missing
* Reconcile results, update local state, and resume the loop

---

### ğŸ¯ Benefit

> If the browser crashes, the tab closes, or the user rage-quits, they can return later and **continue without re-selecting the file or remembering where they left off**.

---

## 2ï¸âƒ£ Nonce Pipelining

### *Optimised â€œFast Modeâ€*

**User Question**

> Do we apply nonce pipelining when Safe Mode is on?

### âš–ï¸ Verdict

**Partially.**

---

### ğŸ›¡ Safe Mode (Current Behaviour)

* Safe Mode deliberately waits for anchor block confirmation
* **Nonce pipelining is incompatible by design**

### âš¡ Fast Mode (Where Optimisation Lives)

Currently:

* We wait ~3 seconds between transactions

#### ğŸš€ The Upgrade

* Manually manage the nonce instead of waiting for wallet updates

**Proposed Logic**

1. Fetch account nonce once (`n`)
2. Loop through chunks
3. Send Chunk 1 with nonce `n`
4. Send Chunk 2 with nonce `n + 1`
5. Send Chunk 3 with nonce `n + 2`

#### âœ… Benefit

* Popup requests can fire as fast as the user can click
* Removes the artificial 3-second delay entirely

#### âš ï¸ Risk

* If the user rejects **one** transaction:

  * All higher-nonce txs fail or get stuck
* Requires **complex error handling and recovery logic**

---

## 3ï¸âƒ£ â­ The Game Changer

### *Batching (Multi-Chunk Uploads)*

### ğŸ† Recommendation

**This is the single most important performance upgrade.**

---

### Current Behaviour

```
1 chunk = 1 transaction = 1 popup
```

A 100KB file (~7 chunks) â†’ **7 wallet popups**

---

### ğŸš€ The Upgrade

Modify the smart contract to accept **multiple chunks in a single call**:

```clarity
(define-public
  (add-chunks-batch
    (hash (buff 32))
    (indices (list 20 uint))
    (data (list 20 (buff 16384)))))
```

---

### ğŸ“ˆ Impact

* ğŸ”¢ **Batch size:** 10â€“20 chunks per transaction
* ğŸ–± **Popups:** Reduced by **10Ã—â€“20Ã—**
* ğŸ’° **Cost:** Cheaper (base fee paid once per batch)
* âš¡ **Speed:** Up to **20Ã— faster**

A 100KB file becomes **1 click instead of 7**

---

### ğŸ›  Implementation Plan

1. Update Clarity contract with `add-chunks-batch`
2. Slice `currentChunks` into batches (e.g. groups of 10)
3. Iterate over **batches**, not individual chunks

---

## 4ï¸âƒ£ Compression

### *GZIP / Brotli*

### ğŸ“Œ Recommendation

Implement **client-side compression**.

---

### ğŸ”§ How It Works

1. User selects `image.png` (1MB)
2. JS compresses using **native browser APIs**
3. Output: `image.png.gz` (~600KB)
4. Inscribe compressed bytes
5. Set headers:

   ```
   mime-type: image/png
   content-encoding: gzip
   ```

---

### ğŸ¯ Benefit

* ğŸ’¸ **30â€“50% cost reduction**
* ğŸ–± Fewer chunks, fewer clicks

---

### â­â­ IMPORTANT â­â­

### **Player Decompression**

> The player must decompress before rendering â€”
> **this is trivial with standard JavaScript libraries and browser APIs.**

**Examples:**

* `CompressionStream`
* `DecompressionStream`
* `pako`
* Native `ReadableStream` pipelines

> **This is not a blocker and should be treated as a solved problem.**

---

## 5ï¸âƒ£ Mempool Awareness

### *RBF / Stuck Transactions*

### â— Problem

Transactions may sit unconfirmed if fees spike.

---

### ğŸ”§ Upgrade

* Monitor the mempool
* If a chunk tx is pending >10 minutes:

  * Show **â€œBoost Feeâ€** button
* Re-submit using **Replace-By-Fee (RBF)**

  * Same nonce
  * Higher fee

---

## ğŸ§­ Summary Roadmap

### ğŸš€ Immediate (Low Effort)

1. **Local Storage Auto-Resume**
   Fixes *â€œI lost my progressâ€* anxiety.

### âš¡ Short Term (High Impact)

2. **Smart Contract Batching**
   Eliminates *â€œtoo many clicksâ€*.

### ğŸ§  Medium Term

3. **Manual Nonce Management (Fast Mode)**
   Removes the 3-second delay entirely.

---
